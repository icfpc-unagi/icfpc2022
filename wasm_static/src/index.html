<!doctype html>
<html>

<head>
  <meta charset="utf-8" />
  <title>My First Parcel App</title>
</head>

<body>
  <form>
    <label for="problem_id1">
      Problem ID:
      <input type="number" id="problem_id1" value="1" min="1" max="40" required/>
    </label>
    <input type="submit" value="Load best submission">
  </form>
  <textarea id="isl1" rows="20" cols="40"></textarea>
  <canvas id="canvas1" width="400" height="400"></canvas>
  <div>score: <span id="score1"></span></div>
  <div>cost: <span id="cost1"></span></div>
  <div>similarity: <span id="similarity1"></span></div>

  <textarea id="initial_config" rows="20" cols="40"></textarea>
  <img id="initial_png" width="400" height="400" alt="initial png">
  <img id="target_png" width="400" height="400" alt="target png">
</body>
<script type="module">
  import init, * as icfpc2022 from "../../pkg/icfpc2022.js?4"
  (async () => {
    await init()
    window.icfpc2022 = icfpc2022

    const base1 = 'https://icfpc.sx9.jp/problems/'
    const base0 = 'https://cdn.robovinci.xyz/imageframes/'
    const problem_id1 = document.getElementById('problem_id1')
    const isl1 = document.getElementById('isl1')
    const canvas1 = document.getElementById('canvas1')
    const cost1 = document.getElementById('cost1')
    const similarity1 = document.getElementById('similarity1')
    const score1 = document.getElementById('score1')
    const initial_config = document.getElementById('initial_config')
    const initial_png = document.getElementById('initial_png')
    const target_png = document.getElementById('target_png')

    async function loadProblem(problemId) {
      let resp = await fetch(`${base1}${problemId}.json`)
      let json = await resp.json()
      if (json.canvas_link) {
        fetch(json.canvas_link.replace(base0, base1))
          .then(resp => resp.blob())
          .then(blob => initial_png = URL.createObjectURL(blob))
      }
      if (json.initial_config_link) {
        fetch(json.initial_config_link.replace(base0, base1))
          .then(resp => resp.text())
          .then(text => initial_config.value = text)
      }
      if (json.target_link) {
        fetch(json.target_link.replace(base0, base1))
          .then(resp => resp.blob())
          .then(blob => target_png.src = URL.createObjectURL(blob))
      }
    }
    problem_id1.addEventListener('value', e => loadProblem(e.target.value))
    loadProblem(problem_id1.value)

    async function loadSubmission(problemId) {
      let resp = await fetch(`https://icfpc.sx9.jp/scvzcaae/submission?problem_id=${problemId}`)
      let json = await resp.json()
      isl1.value = json.SubmissionSolution
    }
    problem_id1.form.addEventListener('submit', e => {
      loadSubmission(problem_id1.value)
      update()
      e.preventDefault()
    });
    loadSubmission(problem_id1.value)

    function update() {
      let managed = new icfpc2022.ManagedCanvas(canvas1)
      managed.apply(isl1.value)
      cost1.innerText = managed.cost()
    }
    isl1.addEventListener('input', e => update())
  })()
</script>

</html>
